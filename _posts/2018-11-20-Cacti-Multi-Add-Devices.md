---
layout: post
title: Массовое добавление в Cacti
date: 2018-11-20 17:00:00
categories: [Cacti, Dev]
---

*Чет я ничего не бложил давно...*

![Cacti](/images/cacti.png)

Welcome back! Прошел почти месяц, а постов и след простыл. Но пришла пора исправить эту оплошность. Сегодня мы поговорим о массовом добавлении устройств в Cacti, а также автоматической генерации графиков при добавлении. Поехали!

Нативной поддержки массового добавления устройств, как и во многих системах, в Cacti нет. Зато для кактуса есть специальный cli скрипт, который позволяет добавлять устройства через терминал, минуя интерфейс. Ну а тут уже нет ничего проще, чем написать скрипт для того, чтобы подцепить данные устройств с, например, файла :)

```php

<?php

ini_set('error_reporting', E_ALL);
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);

echo "<pre>";
$devices_list = "test_devices.txt"; //file with list of ips
$path_to_cli_cacti = "/usr/share/cacti/cli"; //full path to cli directory of cacti
$community_name = "public"; //name of your community of devices
$template_id = 5; //id of template for your $devices
$explode_separator = "	"; //the symbol for separate description and ip


$devices = file($devices_list);

foreach($devices as $device){
  $device_parts = explode($explode_separator, $device);
  $output = shell_exec("php ".$path_to_cli_cacti."/add_device.php --community=".$community_name." --template=".$template_id." --description=".$device_parts[0]." --ip=".$device_parts[1]);
  print_r($output);
}

?>

```

А вот и моя наработка, созданная специально для этих целей. Она подхватывает имя и ip из файла, которые в данном случае разделены табуляцией (*последствия копипаста из LibreOffice Calc*). Написана, как ни странно, на PHP, но можно спокойно на любом другом языке, даже на *баше*. Запустив этот скрипт, придется подождать достаточно длительное время, особенно, если к устройству автоматически что-то дополнительно цепляется (например, те же графики).

Кстати, скрипт не добавит уже существующие устройства, так что, если в список случайно попадет что-то, что уже есть, то никаких дубликатов не будет.

Это все замечательно, но необходимо автоматически цеплять графики загруженности интерфейсов устройств. Как это сделать? А очень просто! Начиная с 1.0 версии Cacti (*могу ошибаться*), в систему встроен плагин, который позволяет автоматизировать рутинную работу, из-за которой приходится заходить на каждое устройство, искать интерфейсы в up'е и вручную создавать для них графики. Благо то барахло, на котором мне необходимо было работать, как раз поддерживает версию cacti 1.0+. Для начала необходимо включить саму автоматизацию в настройках Cacti:

![Настройки автоматизации](/images/cacti_multi_add/1.png)

Галочки проставлены, но даже сейчас толком еще ничего работать не будет. Необходимо теперь "повесить" на шаблоны устройств необходимые графики, которые автоматически будут создаваться при добавлении новых устройств. Идем в *Templates -> Device*, выбираем нужный шаблон и получаем окно следующего вида:

![Настройки шаблона устройства](/images/cacti_multi_add/2.png)

Здесь мы задаем имя шаблона и ассоциируем с ним необходимые данные. По умолчанию с шаблоном можно ассоциировать графики и запросы. В окне же выше есть и третья группа ассоциаций из плагина [Thresholds]({% post_url 2018-10-29-Cacti-Thresholds %}), который я рассматривал в предыдущей статье.
