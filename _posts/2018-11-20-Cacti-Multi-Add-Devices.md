---
layout: post
title: Массовое добавление в Cacti
date: 2018-11-20 17:00:00
categories: [Cacti, Dev]
---

*Чет я ничего не бложил давно...*

![Cacti](/images/cacti.png)

Welcome back! Прошел почти месяц, а постов и след простыл. Но пришла пора исправить эту оплошность. Сегодня мы поговорим о массовом добавлении устройств в Cacti, а также автоматической генерации графиков при добавлении. Поехали!

Нативной поддержки массового добавления устройств, как и во многих системах, в Cacti нет. Зато для кактуса есть специальный cli скрипт, который позволяет добавлять устройства через терминал, минуя интерфейс. Ну а тут уже нет ничего проще, чем написать скрипт для того, чтобы подцепить данные устройств с, например, файла :)

```php

<?php

ini_set('error_reporting', E_ALL);
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);

echo "<pre>";
$devices_list = "test_devices.txt"; //file with list of ips
$path_to_cli_cacti = "/usr/share/cacti/cli"; //full path to cli directory of cacti
$community_name = "public"; //name of your community of devices
$template_id = 5; //id of template for your $devices
$explode_separator = "	"; //the symbol for separate description and ip


$devices = file($devices_list);

foreach($devices as $device){
  $device_parts = explode($explode_separator, $device);
  $output = shell_exec("php ".$path_to_cli_cacti."/add_device.php --community=".$community_name." --template=".$template_id." --description=".$device_parts[0]." --ip=".$device_parts[1]);
  print_r($output);
}

?>

```

А вот и моя наработка, созданная специально для этих целей. Она подхватывает имя и ip из файла, которые в данном случае разделены табуляцией (*последствия копипаста из LibreOffice Calc*). Написана, как ни странно, на PHP, но можно спокойно на любом другом языке, даже на *баше*. Запустив этот скрипт, придется подождать достаточно длительное время, особенно, если к устройству автоматически что-то дополнительно цепляется (например, те же графики).

Кстати, скрипт не добавит уже существующие устройства, так что, если в список случайно попадет что-то, что уже есть, то никаких дубликатов не будет.

Это все замечательно, но необходимо автоматически цеплять графики загруженности интерфейсов устройств. Как это сделать? А очень просто! Начиная с 1.0 версии Cacti (*могу ошибаться*), в систему встроен плагин, который позволяет автоматизировать рутинную работу, из-за которой приходится заходить на каждое устройство, искать интерфейсы в up'е и вручную создавать для них графики. Благо то барахло, на котором мне необходимо было работать, как раз поддерживает версию cacti 1.0+. Для начала необходимо включить саму автоматизацию в настройках Cacti:

![Настройки автоматизации](/images/cacti_multi_add/1.png)

Галочки проставлены, но даже сейчас толком еще ничего работать не будет. Необходимо теперь "повесить" на шаблоны устройств необходимые графики, которые автоматически будут создаваться при добавлении новых устройств. Идем в *Templates -> Device*, выбираем нужный шаблон и получаем окно следующего вида:

![Настройки шаблона устройства](/images/cacti_multi_add/2.png)

Здесь мы задаем имя шаблона и ассоциируем с ним необходимые данные. По умолчанию с шаблоном можно ассоциировать графики и запросы. В окне же выше есть и третья группа ассоциаций из плагина [Thresholds]({% post_url 2018-10-29-Cacti-Thresholds %}), который я рассматривал в предыдущей статье. Как видно на скриншоте, для шаблона устройства, которое по умолчанию уже есть в Cacti, добавлены ассоциации в виде некоторых графиков (*первый график добавлял я*) и запроса (*по умолчанию*). Вы можете добавлять сколько угодно таких ассоциаций к устройству.

**ВАЖНО!!!** Если ассоциируемые данные настроены так, что их шаблоны можно редактировать, то ассоциируемые с устройством графики автоматически не создадутся. То же самое касается и графиков, которые в последствии создаются из запросов (*например, для снятия трафика по портам; об этом ниже*). Я на решение этой проблемы убил чуть ли не полдня, т.к. в документации об этом ни слова, да и совсем непонятно в какую сторону надо было копать.

Это что касалось статичных графиков. А что, если необходимо снимать данные с портов, количество которых заранее неизвестно? В Cacti по умолчанию отправляется SNMP запрос, который возвращает количество портов и трафик по ним. Это нужно в дальнейшем для создания графиков по трафику портов. Все это дело ТОЖЕ можно автоматизировать, для этого нам понадобится пункт меню *Automation -> Graph Rules*. Там мы создаем новое правило, которое привязываем к определенному запросу (Data Query). Вот как это выглядит на примере:

![Настройки правил привязки графиков](/images/cacti_multi_add/3.png)

Выбираем необходимый запрос, затем необходимый тип графика. В *Device Selection Criteria* необходимо описать те устройства, к которым автоматически должны добавляться графики. Я сделал просто и грубо: ко всему, что имеет не пустой *hostname*, будут цепляться необходимые графики. Но это еще полдела. Теперь необходимо составить условие, которые будет делать выборку из необходимых данных, которые будут использоваться для создания будущих графиков. Аналогично мы поступаем и вручную, когда необходимо создать график траффика на порте. Здесь же вместо этого мы прописываем условия, которые будут делать выборку из необходимых (*в данном случае*) интерфейсов. Я выбрал все интерфейсы, находящиеся в Up'е и которые имеют нумерацию в названии по типу 0/0 (т.к. в запросе спокойно могут попадаться и Vlan'ы).
*В системе есть баг при создании нового правила. Необходимо его добавить сначала в таком виде, в котором оно создается изначально и лишь потом можно изменять поле Data Query, которое откроет все остальные поля.*

Отлично, графики теперь автоматически цепляются. Не пугайтесь, если добавление устройства идет несколько дольше обычного: это абсолютно нормально.

Для того, чтобы это дело красиво выглядело и нам удобно было бы смотреть на графики, можно воспользоваться деревьями устройств и графиков. Это графическое дополнение позволяет поместить на страницу необходимые устройства и даже отдельные графики. Просматривать их можно на вкладке *Graphs* выше:

![Древа графиков](/images/cacti_multi_add/4.png)

Как видно на скриншоте, при добавлении устройства и выборе его на древе, автоматически показываются все графики, привязанные к нему. Этим я и воспользовался для автоматизации (*ну не вручную же добавлять все это удовольствие, не так ли?*).

Собственно, не понадобится даже создавать что-то: в системе уже есть готовое правило, необходимо его просто включить. Идем *Automation -> Tree Rules*, находим там *New Device* и видим следующую картину: 

![Правила добавления на древо](/images/cacti_multi_add/5.png)

Здесь мы задаем имя шаблона, выбираем древо и ветвь, ставим галочку рядом с *Enable Rule*, добавляем условие добавления на древо (*как с графиком*) и вуаля, ~~башня готова~~ древо готово!

Теперь к добавляемым устройствам автоматически будут цепляться графики и они будут автоматически добавлять на необходимое древо. *За сим откланяюсь и надеюсь, что во мне еще стрельнет идейка какой-нибудь интересной статьи :)*
