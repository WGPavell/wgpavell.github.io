---
layout: post
title: Основы cBackup
date: 2018-11-30 17:00:00
categories: [cBackup]
---

*Не прошло и месяца, как новая статья...*

![cBackup](/images/cbackup.png)

Приветствую всех, кто по какой-то неведомой случайности забрел сюда. Пишу очередную статью в своем блоге и в этот раз хочу рассказать о такой вещи, как **cBackup**. Что это и с чем это едят? Сегодня я попробую об этом рассказать. *Хотя, на деле, скорее всего, уйдет далеко не одна статья на эту систему...*

**cBackup** - это веб-приложение, предназначенное для сбора информации с сетевых устройств. Точнее, его главное предназначение - сбор конфигураций с коммутаторов и маршрутизаторов, но собирать необязательно именно конфиги. Я не буду описывать нудный процесс установки, который вы и сами без меня можете прекрасно [почитать](https://cbackup.readthedocs.io/en/latest/getting-started/install/).

![Дайджест cBackup](/images/cbackup_basics/1.png)

После установки перед предстанет нечто подобное, но только без данных. Разумеется, все *железки* вы должны будете занестив БД cBackup'а, а как это сделать - решать уже вам. Система предоставляет по крайней мере 2 способа добавления узлов: автоматически по SNMP и вручную. Добавлять узлы вручную особого труда вам не составит: пункт меню *Узлы -> Добавить вручную*. Форма данных узла выглядит следующим образом:

![Добавление узла вручную](/images/cbackup_basics/2.png)

Полей вроде бы много, но обязательны к заполнению только два: *ip* и *устройство*. Но стоп, погодите-ка, при первом использовании системы никаких устройств нет и добавить узел не получается! Как же так и что делать? Сейчас объясню. Дело в том, что cBackup собирает необходимые данные (*конфиги*), используя **telnet** или **SSH**, а также последовательность команд (для каждого вендора она разная). При чем, строки приглашения могут быть разными (*username* или *login*, например). Все эти данные можно создать отдельно и привязать к конкретной модели устройства, которую вы уже указываете при создании узла (либо же система это делает за вас на автомате). Так что необходимо проделать несколько шагов перед тем, как добавить узел в базу данных, а именно:

1. **Создать шаблон аутентификации** (*Сети и оборудование -> Шаблоны аутентификации*). Это те самые строки приглашения, о которых я говорил чуть ранее. Необходимо указать что и в какой последовательности выводится на экран, чтобы система могла правильно вписать логин и пароль, а также определить момент, когда можно вводить команды. Вот пример такого шаблона аутентификации для некоторых устройств Cisco:
![Пример шаблона](/images/cbackup_basics/7.png)
Обратите внимание  на текст в двойных скобках: это системные переменные, которые подставляются из реквизитов (в данном случае это логин и пароль от telnet). Вы можете описать любую необходимую последовательность для входа устройство (*лично у меня был такой случай, что именно с первого раза не входит на узел и мне пришлось дублировать строчки, чтобы снимать последний конфиг с него*).
![Шаблон аутентификации](/images/cbackup_basics/3.png)
2. **Добавить реквизиты** (*Сети и оборудование -> Реквизиты*). В них указываются необходимые данные для входа: логин-пароль для telnet/ssh, данные SNMP, а также порты, которые используются для того или иного протокола. После добавления реквизитов при редактировании справа появляется столбец, в котором можно проверить работоспособность введенных реквизитов на каком-либо узле.
![Пример реквизитов](/images/cbackup_basics/4.png)
3. **Добавить модель устройства** (*Сети и оборудование -> Устройства*). По умолчанию в системе занесено несколько производителей, но вы можете добавить и своих. Добавление нового вендора ни на что не влияет, разве что более удобоваримого восприятия информации. После этого можно добавлять устройства и привязывать к ним те самые шаблоны, по которым происходит авторизация.
![Добавление новой модели устройства](/images/cbackup_basics/5.png)
4. **Подсети** (*Сети и оборудование -> Подсети*). Этот шаг является необязательным в том случае, если все узлы вы собираетесь добавлять вручную. На деле же тут просто описывается подсеть вида 192.168.1.0/24 и к ней привязываются реквизиты. Переключатель "*Участвует в поиске*" позволяет включить или исключить данную подсеть для сканирования (которое в свою очередь служит тому самому механизму автоматического добавления новых железок).
![Создание подсети](/images/cbackup_basics/6.png)
5. **Добавление узла** (*Узлы -> Добавить вручную*). Вот теперь можно добавить узел **вручную**. На автомате же это делается несколько иначе, но об этом как-нибудь в другой раз.

Что ж, теперь наш узел появился в списке и можно посмотреть его данные, а также изменить в любой момент при необходимости (*если он был занесен вручную*). Но конфиги все еще не получится снять, ибо требует *какое-то пресловутое задание*. Да, для снятия конфигов с узлов необходимо привязать их к заданию резервного копирования, чтобы это делалось как на автомате по расписанию, так и в любой необходимый момент вручную. Все необходимое лежит в категории меню *Процессы*. Для каждого вендора (или определенных групп моделей) необходимо создавать так называемый обработчик задания. Это последовательность команд, необходимых для вывода нужной информации (в том числе и конфигурации устройства). Расчехляйте свои консоли, вспоминайте последовательности команд для вывода конфига на экран. Вспомнили? Отлично, но этого мало. Дело в том, что сейчас практически везде выводимые данные ограничиваются размером окна терминала и следующие выводятся лишь по нажатию клавиш при необходимости. К сожалению или к счастью, но **cBackup** не умеет автоматически нажимать нужное количество раз необходимые клавиши и поэтому важно вывести весь конфиг разом. Как это сделать? Гуглите команды размера терминала или отключения клиппэйджинга. На циске это, например, команда *terminal length 0*. В конец также можно добавить команду выхода из устройства.

![Добавление задания для обработки](/images/cbackup_basics/8.png)

Что ж, необходимая последовательность команд сформирована и теперь ее необходимо занести в базу и привязать к модели(ям) устройств. Нам понадобится пункт меню *Процессы -> Обработчики и операции*. Кнопкой "*Добавить обработчик*" мы добавляем задание, к которому необходимо назначить нужные обработчики под каждый вендор/модель/устройство/прочее. После этого в списке появится наше задание, к которому нужно привязать ту самую **последовательность команд** (или проще говоря, обработчик):

![Добавление обработчика](/images/cbackup_basics/9.png)

Здесь просто указывается протокол и название обработчика. Далее, к обработчику необходимо добавить операции (последовательность команд). Здесь полей будет побольше, но на деле самые необходимые это команда, таймаут и поле SQL-таблицы. Последнее поле особенно важно правильно указать. Эта опция задает при какой именно операции необходимо начать записывать все данные с терминала и в какое поле таблицы (при бэкапе оно единственное, поэтому нам надо записывать, например, вывод команды *show running-config*; *вы можете добавить и свои поля, которые будут записывать и вывод других необходимых вам команд, но об этом как-нибудь в другой раз*).

![Добавление обработчика](/images/cbackup_basics/10.png)

На выходе после создания обработчиков и операций получается что-то подобное:

![Список обработчиков и операций](/images/cbackup_basics/11.png)

Осталось лишь привязать устройства к этим обработчикам и узлы к заданию *backup*. Меню *Процессы -> Назначение задач* поможет нам в этом. Переходим туда и сразу на вкладку "*Дефолтные обработчики устройств*". Далее, выбираем один из двух подходящих вам способов добавления. Первый способ позволяет добавить конкретную модель, второй же - привязать к заданию и обработчику сразу несколько моделей. Важно добавить именно модели, т.к. привязывать обработчики к узлам довольно геморно.

![Привязка модели к задаче и обработчику](/images/cbackup_basics/12.png)

После этого возвращаемся на первую вкладку "*Задачи узлов*" и добавляем наши устройства опять же удобным для нас способом. Я предпочитаю "*Расширенное назначение задачи*", т.к. там можно сразу выбрать имеющиеся железки и привязать их к заданию.

![Массовая привязка узлов к заданию](/images/cbackup_basics/13.png)

Вот теперь можно попробовать снять конфиг с какого-нибудь узла и убедиться в правильности введенных данных. Если все сделано верно, то через некоторое время после обновления страницы вы увидите на странице узла подобную картину:

![Узел после успешно снятого конфига](/images/cbackup_basics/14.png)

Внизу появилась возможность просматривать снятые данные! Более того, если вы используете git, то можно также смотреть и разницу между измененными конфигурациями. Все это довольно просто и удобно сделано и позволяет вам скачать любой успешно снятый конфиг за любую дату.

Правда, это еще не все. Необходимо дать системе знать, когда проводить операцию сбора бэкапов (*если вы, конечно же, не мазохист и не собираетесь бэкапить все вручную*). Необходимо обратиться в *Процессы -> Расписание*. Далее, кнопка "*Добавить запланированную задачу*". Там мы выбираем задачу и время, когда она должна исполняться. Не забудьте добавить задачу *git_commit*, чтобы могла сохраняться история забэкапленных конфигов.

![Расписание](/images/cbackup_basics/15.png)

Вот и все. Это весь необходимый минимум для полноценной работы **cBackup'а**. Не забудьте перезапустить планировщик Java в правом верхнем углу, чтобы расписание заработало (да и убедитесь в том, что Java вообще работает).

P.S. Это не последняя статья по cBackup, у меня еще есть что рассказать. По ходу дела буду формировать свои мысли, наработки, замечания и прочее в отдельные статьи. Система не полноценная, но в целом, она успешно справляется с поставленными ей задачами. Увидимся в следующем месяце! *наверн, а может и нет, хотя какая разница, все равно здесь никого, кроме меня, нет, хыхыхы*
