---
layout: post
title: cBackup Discovery
date: 2018-12-10 11:00:00
categories: [cBackup]
---

*Техноблог не дремлет и я уже успел прикрутить комментарии! ~~Самое время поспамить плохими отзывами :)~~*

![cBackup](/images/cbackup.png)

Пришло время продолжить писать про **cBackup** и рассказать о такой особенности, как автоматическое добавление узлов в систему. Важное замечание перед началом: **cBackup** заносит узлы на основании результатов SNMP опроса, поэтому железки, на которых он не настроен, будут проигнорированы. **cBackup** может работать по SNMP с версиям v1, v2 и v2c и для работы достаточно будет знать значение *Read Community*.

Первым делом необходимо заполнить строчку *Read Community* в реквизитах:

![Read Community](/images/cbackup_discovery/1.png)

Далее, необходимо добавить задачу *discovery* в расписание в удобное для вас время:

![Расписание](/images/cbackup_discovery/2.png)

... и не забыть обновить планировщик Java в правом верхнем углу:

![Планировщик Java](/images/cbackup_discovery/3.png)

Также необходимо создать подсеть(и) в системе, по которой(ым) будет вестись поиск (*Сети и оборудование -> Подсети -> Добавить подсеть*):

![Создание подсети](/images/cbackup_discovery/4.png)

Переключатель "*Участвует в поиске*" необходимо включить обязательно, иначе *discovery* ничего не проверит. Диапазон адресов, показанный в примере, сканируется примерно за час. Для уже добавленных узлов также можно присвоить эту подсеть.

Итак, чем занимается задача discovery? Она делает SNMP опрос по созданными вами подсетями (для которых включен поиск) и если какой-либо узел возвращает ответ, то происходит одно из двух:

* Если узла нет в базе, то он *автоматически* заносится в систему.
* Если узел уже есть в базе, то обновляет его данные согласно ответу.

При первом скане скорее всего у вас появится очень много сообщений о том, что найдено много новых моделей устройств. Для *cBackup* необходимо сопоставить данные, полученные по SNMP, с моделями в базе и придется это сделать вручную. Также для всех найденных узлов придется отдельно назначать задачу (соответственно и для моделей устройств тоже). Сообщения о новых моделях высвечиваются в области уведомлений сверху (иконка колокольчика). Там же можно перейти на страницу всех уведомлений:

![Список сообщений](/images/cbackup_discovery/5.png)

Список всех неизвестных устройств можно также посмотреть в меню *Сети и оборудование -> Устройства -> Просмотр неизвестных устройств*:

![Список неизвестных устройств](/images/cbackup_discovery/6.png)

Нажав на *+* (или же на *Click here* в сообщении), открывается следующая форма:

![Неизвестное устройство](/images/cbackup_discovery/7.png)

Здесь необходимо ассоциировать SNMP ответ с устройством в базе данных. Создавать ли на каждый ответ отдельную модель устройства, либо ассоциировать с одной или несколькими - решать вам, смотря какие потребности. Для себя я создавал на каждый уникальный ответ (*были и одинаковые*) отдельное устройство (*мало ли что может произойти*).

Как найти автоматически добавленные узлы? Способов несколько, но конкретной менюшки для просмотра узлов (*а вот и че можно допилить в **cBackup'е**, кстати*), добавленных за последнее исполнение задачи - нет. Например, в дайждесте можно смотреть узлы без назначения:

![Дайждест](/images/cbackup_discovery/8.png)

В логах узлов (*Логи -> Узлы*) можно отфильтровать записи по действию *CREATE*:

![Логи узлов](/images/cbackup_discovery/9.png)

Ну и еще один способ - фильтрация узлов по способу добавления (*Узлы -> Список*):

![Метод обнаружения узлов](/images/cbackup_discovery/10.png)

Таким образом можно найти узлы, добавленные через задачу *discovery*.

Есть странное ограничение для узлов, добавленных таким способом - их нельзя редактировать, кнопка *Изменить узел* недоступна, а при попытке обхода со страницы выкидывает с ошибкой. Вероятно, снять это ограничение в коде не сложно, но непонятно какие последствия это может за собой повлечь и зачем запретили.

Очередная статья подходит к концу. Далее, я скорее всего уже буду рассказывать о том, как модифицировал (и скорее всего еще буду модифицировать) **cBackup** своими силами. С этого начнется очередная категория статей по **Yii2**. Ах да, к блогу я прикрепил сервис комментариев, так что каждую запись можно комментировать. Дерзайте!)
