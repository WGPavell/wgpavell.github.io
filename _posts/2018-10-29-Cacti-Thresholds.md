---
layout: post
title: Тревожный кактус
---

*Вероятно, я ждал, что один из первых постов будет посвящен какому-нибудь фреймворку, но что-то пошло не так.*

![Cacti](/images/cacti.png)

Недавно мне была поставлена задача изучить систему мониторинга сетевых устройств Cacti. Довольно мерзкая вещь, если учесть времена, откуда у неё ноги растут. Старый интерфейс, код на соплях и многое другое заставили меня поломать мозг в попытках понять как работает эта, на первый взгляд из палеозойской эры, система. Помню, как еще недавно бился головой об клаву в попытках решить проблему с построением графиков. Если коротко, то все графики хранятся в отдельных файлах, а для их изменения системе не хватало прав. Аналогично и с логами, они тупо не писались (хотя еще на этапе установки система смогла сделать первые записи). Это довольно странно, учитывая, что по идее кактус должен разворачиваться на машине автоматом (включая и все необходимые права на файлы и директории, которые изначально мне тоже пришлось редактировать). Но все же, эту проблему я оставил позади (если в этом и заключалась вообще проблема, ибо система странная и не всегда заводится с первого раза).

В будущем еще предстоит придумать способ занести в систему порядка ~1000 устройств и под каждое из них создавать график на каждый интерфейс, а также выносить их на отдельное древо. Вроде как проблему с автоматическим созданием графиков и занесением устройства на дерево я решил, для этого в Cacti 1+ версии используется встроенный плагин автоматизации. Найти его можно в меню консоли категории __Automation__. Автоматизировать в системе можно практически все, начиная от банального размещения на древе, заканчивая сканированием подсетей и добавлением устройств. Для этого там задаются специальные шаблоны и это чем-то напоминает ветвление. По умолчанию все это добро по какой-то причине выключено (учитывая, что есть некоторые уже готовые шаблоны) и нужно все ручками подрубать.

![Шаблон устройства](/images/cacti_thresholds/1.png)
![Шаблон графиков](/images/cacti_thresholds/2.png)

Как видно по скриншотам, шаблоны очень примитивные и охватывают практически каждое устройство. В данном случае на графики наносятся физические интерфейсы в состоянии *Up* устройств, которым прописан какой-либо *hostname*.

___

Но речь в сегодняшнем посте больше не о сложностях Cacti. Копаться во всех этих графиках, конечно, здорово, но хотелось бы выявлять те устройства, на которых имеются определенные проблемы. Например, трафик на интерфейсе превысил какую-то скорость или утилизация процессора достигла критической отметки. Стандартными средствами Cacti этого не предусмотрено, но благо энтузиасты из того же Кактуса уже давно выкатили решение, успешно работающее на современных версиях систем. Речь о плагине __thold__, который работает со значениями графиков и при достижении заданных значений начинает бить тревогу. Вот как это примерно выглядит:

![Список thresholds](/images/cacti_thresholds/3.png)

На скриншоте список интерфейсов различных устройств. В данном случае подсчитывается трафик портов и если какой-либо из них превысит норму, то он будет подсвечен красным или оранжевым в зависимости от степени превышения (всего 2 уровня: *Warning* и *Alert*; задать можно как одно из них, так и оба). По аналогии с автоматизацией, для этого плагина тоже можно создать шаблон на графики:

![Шаблон thresholds](/images/cacti_thresholds/4.png)

Список параметров может немного пугать, но на деле тут все очень просто. Выбирается источник данных, выбирается поле источника, а внизу указываются значения Warning и Alert, при которых срабатывает threshold. При чем, указывать можно не только верхний (максимальный) предел, но и нижний (минимальный). По желанию можно указать цвета Warning и Alert состояний, тогда они будут рисоваться на графике в виде линий. Обязательно нужно поставить галочку *Enabled*, чтобы шаблон работал.

Перед тем, как начать добавлять новые графики, необходимо поставить галочку *Auto Create Thresholds* в настройках плагина, иначе шаблон не заработает. По аналогии можно добавлять "пороги" и вручную, через категорию консоли *Management*.

Первые несколько часов в работе плагина наблюдались странные глюки (не писались логи, плагину передавались странные отрицательные значения вроде *-2147483648* и т.д.), но каким-то чудом проблема ушла сама собой и теперь в логах видны только счастливые зеленые строчки. Сначала я все списал на то, что папку плагина не переименовал (а в Readme было сказано это сделать), но оставив на некоторое время работать систему, я не прогадал. Полет отличный, система пашет. Ее можно настроить на посылку уведомлений на e-mail при необходимости.

___

Как-то так. Вообще, по мне так это очень странно, что при добавлении элементов в систему по началу все глючит, но затем все приходит в норму. Скорее всего, это издержки того, что система очень старая (ее первый релиз был аж в начале бородатых 2000х). Остается только придумать способ занести список из 1000 айпишников в систему, но об этом как-нибудь в другой раз. Если будет вообще какой-либо смысл об этом писать.
